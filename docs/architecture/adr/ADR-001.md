# ADR-001: Calculator と CalculationHistory の結合にオプショナル DI を採用する

| 項目 | 内容 |
|---|---|
| **ID** | ADR-001 |
| **日付** | 2026-02-23 |
| **ステータス** | 承認 |
| **決定者** | architect |

---

## コンテキスト

`Calculator`（ドメイン計算層・変化速度: 低）に、`CalculationHistory`（アプリケーション記録層・変化速度: 中〜高）を結合する方式を選定する必要があった。

ペースレイヤリングの原則（変化速度の遅い層は速い層に依存してはならない）に従い、`Calculator` が `CalculationHistory` に深く依存することを避けながら、履歴記録機能を統合する方式を検討した。

---

## 検討した候補

### 候補 A: 自己生成（禁止）

`Calculator` 内部で `CalculationHistory` インスタンスを生成する。

**棄却理由**: ドメイン計算層がアプリケーション記録層を直接インスタンス化する構造となり、**ペースレイヤリング違反**。変化速度の遅い層が速い層を内包することで、安定層の凝集度が損なわれる。

### 候補 B: 必須引数（棄却）

`Calculator.__init__` の引数として `CalculationHistory` を必須で受け取る。

**棄却理由**: 既存の `Calculator()` の呼び出し元がすべて破壊される。**後方互換性を破壊**するため採用不可。

### 候補 C: オプショナル引数（採択）

`Calculator.__init__` の引数として `Optional[CalculationHistory] = None` で受け取る。

**採択理由**:
- 既存の `Calculator()` 呼び出しが無変更で動作する（後方互換）
- `CalculationHistory` を外部から注入できる（DI）
- テスト時はモックを注入して独立に検証できる（テスタビリティ）
- `None` の場合は履歴記録なしで動作する（オプショナル性の明示）

---

## 決定

**候補 C（オプショナル引数）を採用する。**

```python
from __future__ import annotations
from typing import TYPE_CHECKING, Optional

if TYPE_CHECKING:
    from src.history import CalculationHistory

class Calculator:
    def __init__(self, history: Optional[CalculationHistory] = None) -> None:
        self._history = history
```

- 実行時の循環インポートを防ぐため、`CalculationHistory` の型インポートは `TYPE_CHECKING` ガードで保護する
- インスタンス変数 `_history` に保持し、演算成功後に `record()` を呼ぶ

---

## 結果

### 正の影響

- **後方互換維持**: 既存の `Calculator()` 呼び出しに変更不要
- **テスト容易性**: `CalculationHistory` のモックを注入して独立テスト可能
- **独立差し替え**: 将来の実装変更時も DI により影響を局所化できる

### 負の影響

- **ステートレス概念の希薄化**: `Calculator` が内部状態（`_history`）を持つことで、純粋なステートレス計算器という概念が薄れる

### リスク

- **None チェック漏れのサイレントバグ**: `_history` が `None` かどうかの確認を実装中に漏らすと、履歴が記録されないまま正常終了するサイレントバグが発生する。コードレビューで `if self._history is not None:` の確認を徹底する。

---

## 関連ドキュメント

- [module-map.md](../module-map.md) — 層の対応と依存方向
- [data-flow.md](../data-flow.md) — 履歴記録フロー
